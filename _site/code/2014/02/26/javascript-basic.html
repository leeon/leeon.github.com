<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>JavaScript中的 变量、作用域链、执行上下文</title>
  <meta name="description" content="" />

  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="canonical" href="http://atleeon.com/code/2014/02/26/javascript-basic.html">

  <link rel="shortcut icon" href="/assets/images/favicon.ico">
<!--  <link rel="stylesheet" href=""> -->
  <link rel="stylesheet" href="http://brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
  <link rel="stylesheet" type="text/css" media="print" href="/css/print.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="/css/style.css" />
  <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>

  <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
  <script type="text/javascript" src="/assets/js/index.js"></script>
  <script type="text/javascript" src="/assets/js/readingTime.min.js"></script>
</head>

  <body itemscope itemtype="http://schema.org/Article">
    <!-- header start -->
<!-- 
<a href="http://atleeon.com" class="logo-readium"><span class="logo" style="background-image: url(http://cdn4atleeon.qiniudn.com/image/site/logo.jpg)"></span></a>
 -->
<!-- header end -->

    <main class="content" role="main">
      <article class="post">
        
        <div class="noarticleimage">
          <div class="post-meta">
            <h1 class="post-title">JavaScript中的 变量、作用域链、执行上下文</h1>
          </div>
        </div>
        <br>
        <!-- 无封面时不显示正文 -->
        
        <section class="post-content">
          <div class="post-reading">
            <span class="post-reading-time"></span> read
          </div>
          <a name="topofpage"></a>
          <h2 id="intro">Intro</h2>

<p>之前一直在前端使用JavaScript,主要是操作DOM实现网页中特定的效果。接触Node.js后，JavaScript就开始在Server和Desktop上发挥作用。本文梳理一下JavaScript的一些语法上的几个核心概念,并通过一些例子来加深理解。</p>

<!-- break -->

<h2 id="execution-context">Execution context</h2>

<p>Execution context (简称EC) 是一个虚拟的概念，区分了不同的代码片段以及执行环境。JavaScript中的代码环境主要有三种，分别是Global Code, Function Code和Eval Code. 其中Global code是<code>.js</code>文件中直接执行的代码，或者<code>&lt;script&gt;</code>标签中的内容。Function code是进入函数调用时候进入的代码环境。Eval code 是指使用<code>eval()</code>的代码内容。</p>

<p>在程序运行过程中，一系列的 execution context 构成了一个context stack。比如，程序一开始就进入了Global context，存在栈底。每当进入一个新的context，就会压栈，栈顶的内容是当前活跃的context。下图演示了context stack的变化。</p>

<p class="center"><img src="http://dmitrysoshnikov.com/wp-content/uploads/ec-stack-changes.png" alt="" style="max-width:400px" /></p>

<p>Execution context 包含了主要三个部分，Variable object,Scope Chain和this. JavaScript运行时记录和查找变量就是依靠的这些结构。</p>

<p class="center"><img src="http://dmitrysoshnikov.com/wp-content/uploads/execution-context.png" alt="" style="max-width:400px" /></p>

<h2 id="vo--ao">VO &amp; AO</h2>

<h4 id="variable-object-vo">Variable Object （VO）</h4>

<p>vo是一个与context相关联的一个特殊的object。所谓关联，就是VO存储着在当前context中声明的变量和函数声明（注：是FD而非FE）,当程序试图寻找某一个变量的时候，就会首先检查VO.</p>

<pre><code>var foo = 10;
function bar() {} // function declaration, FD
(function baz() {}); // function expression, FE
 
console.log(
  this.foo == foo, // true
  window.bar == bar // true
);
 
console.log(baz); // ReferenceError, "baz" is not defined
</code></pre>

<p>下图显示了上面代码，Global context中VO的属性，即变量声明，和函数bar的声明，而没有baz.因为后者属于函数表达式。</p>

<p class="center"><img src="http://dmitrysoshnikov.com/wp-content/uploads/variable-object.png" alt="" style="max-width:400px" /></p>

<p>对于变量声明，必须使用<code>var</code>关键字.”全局”的声明方式，只是给Global添加了一个属性，并没有严格的声明变量，也不会添加到VO,下面的代码可以验证，因为JavaScript中变量有can’t delete的特性，所以是不能删除的，而属性可以。</p>

<pre><code>var temp1 = 1; //declare a variable
temp2 = 2; //actually add a new attribute to global

delete temp1;//false 
delete temp2; //true
</code></pre>

<h4 id="activation-object-ao">Activation Object （AO）</h4>

<p>在函数环境中，VO就变成了AO. 并且增加了函数参数的列表。如下面的代码对应的AO。</p>

<pre><code>function foo(x, y) {
  var z = 30;
  function bar() {} // FD
  (function baz() {}); // FE
}
foo(10, 20);
</code></pre>

<p class="center"><img src="http://dmitrysoshnikov.com/wp-content/uploads/activation-object.png" alt="" style="max-width:300px" /></p>

<p>JavaScript代码运行分为两个阶段，<code>entering the execution</code> 和 <code>code execution</code>.VO/AO在第一个阶段会被初始化，所以FD函数声明，会在第一个阶段加入到VO/AO，而FE函数表达式则不会。 </p>

<h2 id="scope-chain">Scope Chain</h2>

<p>作用域链是用于JavaScript寻找变量的结构，由一系列的对象组成，如果一个变量在自己所在的Scope中找不到，也就是自己VO/AO没有，（可以看出，自己的VO/AO）是作用域链的顶端）就去父节点的VO/AO去寻找。根据这个原理，JavaScript中的作用域和其他高级编程语言（利用Block区分作用域）不同，通过函数调用决定作用域链，因为函数调用会创建新的VO/AO.本Scope内不存在的变量叫做<code>free variable</code>.</p>

<pre><code>var x = 10;
 
(function foo() {
  var y = 20;
  (function bar() {
    var z = 30;
    // "x" and "y" are "free variables"
    // and are found in the next (after
    // bar's activation object) object
    // of the bar's scope chain
    console.log(x + y + z);
  })();
})();
</code></pre>

<p class="center"><img src="http://dmitrysoshnikov.com/wp-content/uploads/scope-chain.png" alt="" style="max-width:300px" /></p>

<p>值得注意的是JavaScript中的作用域链是静态的，当函数被创建的时候，其作用域链就是foo.[[scope]],其中[[scope]]就是globalContext.VO,当函数激活（被调用）的时候，其作用域链为AO+[[scope]].
下面的代码可以看出，foo在创建的时候,其作用域链中并没有 invokeFoo.AO，而是在其创建时刻的globalContext.VO.</p>

<pre><code>var x = 1;
function foo () {
    console.log(x);
}

function invokeFoo(){
    var x = 2;
    foo();
}
invokeFoo(); // we get 1 here
</code></pre>

<p>另外一个经典的例子是循环绑定函数，结果每一次都是3，原因在于三次赋值的函数都共享了相同的[[scope]],寻找变量i的时候，其实访问都是同一个。都在Global.VO中。</p>

<pre><code>var data = [];
for(var i = 0 ; i &lt; 3; i++){
    data[i]=function() {
        console.log(i);
    }
}
data[0]();//get 3
data[1]();//get 3
data[2]();//get 3
</code></pre>

<p>使用闭包，改进之后。创建新函数的时候，[[scope]]都会加上匿名外面匿名函数的AO,进而获得传进来的变量。</p>

<pre><code>var data = [];

for(var i = 0 ; i &lt; 3; i++){
    data[i]=(function(x) {
        return function  () {
            console.log(x);
        }
    })(i);
}

data[0]();
data[1]();
data[2]();
</code></pre>

<h2 id="this">This</h2>

<p><strong>this</strong> 是context中的一个属性，并不属于任何变量，因此也不能被赋值。在全局环境中，this就表示global.在函数中，this的值取决于调用当前函数的context.</p>

<h2 id="conclusion">Conclusion</h2>

<p>以上是JavaScript中几个基本的但是很重要的概念，有助于理解它的基本运行机制。此外还有一些重要的概念，比如函数、原型链、事件机制等。本文大部分参考了 Dmitry Soshnikov 的<a href="http://dmitrysoshnikov.com/">ECMA-262 Series</a>.</p>

<p>以上。</p>


        </section>
        <footer class="post-footer">
          <section class="share">
            
              
                <a class="icon-twitter" href="http://twitter.com/share?text=JavaScript%E4%B8%AD%E7%9A%84+%E5%8F%98%E9%87%8F%E3%80%81%E4%BD%9C%E7%94%A8%E5%9F%9F%E9%93%BE%E3%80%81%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87&amp;url=http://atleeon.com/code/2014/02/26/javascript-basic"
                  onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
                <i class="fa fa-twitter"></i><span class="hidden">twitter</span>
                </a>
              
            
              
            
          </section>
        </footer>
        <div class="bottom-teaser cf">
          <div class="isLeft">
            <h5 class="index-headline featured"><span>戳</span></h5>
            <section class="author">
              <div class="author-image" style="background-image: url(http://cdn4atleeon.qiniudn.com/image/site/author/leeon/leeon.jpg)">Blog Logo</div>
              <h4>Leeon</h4>
              <p class="bio"></p>
              <hr>
              <p class="published">写于 
                <time datetime="2014-02-26 00:00">
                    2014 年 02 月 26 日
                </time>
              </p>
            </section>
          </div>
          
          <div class="isRight">
            <h5 class="index-headline featured"><span> 乱步 </span></h5>
            <footer class="site-footer">
              
              <p class="published" style="text-align: center;">
                  <a href="/write/2014/02/10/startup-zhihu.html" class="pre"> 『 创业时，我们在知乎上聊什么 』</a>
              </p>
              
              <hr>
              
              <p class="published" style="text-align: center;">
                <a href="/code/2014/03/01/javascript-event.html" class="next"> 『 JavaScript 中的DOM事件 』</a>
              </p>
              

              <!-- <a class="subscribe" href="/feed.xml"> <span class="tooltip">  -->
              </div>
            </footer>
          </div>
        </div>
      </article>
    </main>
    <div class="bottom-closer">
      <div class="background-closer-image"  style="background-image: url(/assets/images/cA4aKEIPQrerBnp1yGHv_IMG_9534-3-2.jpg)">
        Image
      </div>
      <div class="inner">
        <h1 class="blog-title">Zephyrus</h1>
        <h2 class="blog-description"></h2>
        <a href="/" class="btn">去 首页</a>
      </div>
    </div>
  </body>
</html>
